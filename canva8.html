<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ª–∏–Ω–∏–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      display: flex;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .controls {
      width: 350px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .canvas-container {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }

    h1,
    h2,
    h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .control-group {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }

    .mode-btn,
    .color-btn,
    button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mode-btn:hover,
    .color-btn:hover,
    button:hover {
      background: #f0f0f0;
    }

    .mode-btn.active {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }

    .color-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      padding: 0;
    }

    .color-btn.active {
      transform: scale(1.1);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }

    .status {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 14px;
    }

    .status-item {
      margin-bottom: 5px;
    }

    #drawingCanvas {
      border: 1px solid #ddd;
      background: white;
      cursor: crosshair;
      flex: 1;
      width: 100%;
    }

    .object-panel {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      background: #f9f9f9;
      max-height: 400px;
      overflow-y: auto;
    }

    .object-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }

    .category-btn {
      padding: 5px 10px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    .category-btn.active {
      background: #3498db;
      color: white;
    }

    .objects-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .object-item {
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px 2px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      cursor: pointer;
      background: white;
    }

    .object-item.selected {
      border-color: #3498db;
      background: #e3f2fd;
    }

    .object-icon {
      width: 40px;
      height: 40px;
      margin-bottom: 5px;
    }

    .object-icon img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: contain;
    }

    .object-name {
      text-align: center;
      font-size: 10px;
      color: #666;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
    }

    #clearAll {
      background: #e74c3c;
      color: white;
    }

    #showAllLines {
      background: #2ecc71;
      color: white;
    }

    #savePDF {
      background: #9b59b6;
      color: white;
    }

    .length-edit-overlay {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .length-edit-overlay input {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      width: 100px;
    }

    .length-edit-overlay button {
      padding: 5px 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Å–≤–æ–π—Å—Ç–≤ */
    .properties-panel {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }

    .property-group {
      margin-bottom: 15px;
    }

    .property-label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 12px;
    }

    .property-input {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 12px;
    }

    .property-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .rotate-btn {
      background: #f39c12;
      color: white;
      border: none;
    }

    .apply-btn {
      background: #27ae60;
      color: white;
      border: none;
    }

    .cancel-btn {
      background: #95a5a6;
      color: white;
      border: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏ */
    .line-properties-panel {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
<div class="container">
  <div class="controls">
    <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –ª–∏–Ω–∏–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤</h1>

    <div class="control-group">
      <h3>–†–µ–∂–∏–º—ã</h3>
      <div class="toolbar">
        <button class="mode-btn active" data-mode="draw">‚úèÔ∏è –†–∏—Å–æ–≤–∞—Ç—å</button>
        <button class="mode-btn" data-mode="move">‚ÜïÔ∏è –ü–µ—Ä–µ–º–µ—â–∞—Ç—å</button>
        <button class="mode-btn" data-mode="edit">üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="mode-btn" data-mode="delete">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>

    <div class="control-group">
      <h3>–¶–≤–µ—Ç –ª–∏–Ω–∏–∏</h3>
      <div class="toolbar">
        <button class="color-btn active" data-color="black" style="background: black"></button>
        <button class="color-btn" data-color="red" style="background: red"></button>
        <button class="color-btn" data-color="blue" style="background: blue"></button>
        <button class="color-btn" data-color="green" style="background: green"></button>
      </div>
    </div>

    <div class="control-group">
      <h3>–ü—Ä–∏–≤—è–∑–∫–∞</h3>
      <div>
        <input type="checkbox" id="snapToGrid" checked>
        <label for="snapToGrid">–ö —Å–µ—Ç–∫–µ</label>
      </div>
      <div>
        <input type="checkbox" id="snapToPoints" checked>
        <label for="snapToPoints">–ö —Ç–æ—á–∫–∞–º</label>
      </div>
    </div>

    <div class="control-group">
      <h3>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
      <div class="object-panel">
        <div class="object-categories">
          <button class="category-btn active" data-category="all">–í—Å–µ</button>
          <button class="category-btn" data-category="doors_windows">–î–≤–µ—Ä–∏</button>
          <button class="category-btn" data-category="fan">–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã</button>
          <button class="category-btn" data-category="fire">–û–≥–æ–Ω—å/–°—Ä–µ–¥—Å—Ç–≤–∞ –ø–∞–∂–∞—Ä–æ—Ç—É—à–µ–Ω–∏—è</button>
          <button class="category-btn" data-category="boom">–í–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</button>
          <button class="category-btn" data-category="pumps">–ù–∞—Å–æ—Å—ã</button>
          <button class="category-btn" data-category="jumper">–ü–µ—Ä–µ–º—ã—á–∫–∏</button>
        </div>
        <div class="objects-grid" id="objectsGrid">
          <!-- –û–±—ä–µ–∫—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞ -->
    <div class="control-group properties-panel" id="propertiesPanel" style="display: none;">
      <h3>–°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞</h3>
      <div id="propertiesContent">
        <div class="property-group">
          <label class="property-label">–ú–µ—Ç–∫–∞:</label>
          <input type="text" id="propertyLabel" class="property-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞">
        </div>
        <div class="property-group">
          <label class="property-label">–®–∏—Ä–∏–Ω–∞:</label>
          <input type="number" id="propertyWidth" class="property-input" min="1" max="200">
        </div>
        <div class="property-group">
          <label class="property-label">–í—ã—Å–æ—Ç–∞:</label>
          <input type="number" id="propertyHeight" class="property-input" min="1" max="200">
        </div>
        <div class="property-actions">
          <button id="rotateButton" class="rotate-btn">üîÑ –ü–æ–≤–µ—Ä–Ω—É—Ç—å</button>
          <button id="applyProperties" class="apply-btn">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button id="cancelProperties" class="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏ -->
    <div class="control-group line-properties-panel" id="linePropertiesPanel" style="display: none;">
      <h3>–°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏</h3>
      <div id="linePropertiesContent">
        <div class="property-group">
          <label class="property-label">–í—ã—Å–æ—Ç–∞ (cheight):</label>
          <input type="number" id="lineCheight" class="property-input" placeholder="–í—ã—Å–æ—Ç–∞ –≤ –º">
        </div>
        <div class="property-group">
          <label class="property-label">–®–∏—Ä–∏–Ω–∞ (cwidth):</label>
          <input type="number" id="lineCwidth" class="property-input" placeholder="–®–∏—Ä–∏–Ω–∞ –≤ –º">
        </div>
        <div class="property-group">
          <label class="property-label">–û–±—ä–µ–º (cvolume):</label>
          <input type="number" id="lineCvolume" class="property-input" placeholder="–û–±—ä–µ–º –≤ –º¬≥">
        </div>
        <div class="property-group">
          <label class="property-label">–î–ª–∏–Ω–∞ –ª–∏–Ω–∏–∏:</label>
          <input type="text" id="lineLength" class="property-input" readonly>
        </div>
        <div class="property-actions">
          <button id="applyLineProperties" class="apply-btn">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button id="cancelLineProperties" class="cancel-btn">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>

    <div class="control-group">
      <h3>–î–µ–π—Å—Ç–≤–∏—è</h3>
      <div class="action-buttons">
        <button id="clearAll">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        <button id="showAllLines">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã</button>
        <button id="savePDF">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PDF</button>
        <button id="showLineProperties">–ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–π</button>
      </div>
    </div>

    <div class="status">
      <h3>–°—Ç–∞—Ç—É—Å</h3>
      <div class="status-item">
        –†–µ–∂–∏–º: <span id="currentMode">–†–∏—Å–æ–≤–∞–Ω–∏–µ</span>
      </div>
      <div class="status-item">
        –¶–≤–µ—Ç: <span id="currentColor">black</span>
      </div>
    </div>
  </div>

  <div class="canvas-container">
    <h2>–û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è</h2>
    <canvas id="drawingCanvas" width="800" height="600"></canvas>
  </div>
</div>

<script>
  // –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —Ö–æ–ª—Å—Ç–µ
  class CanvasObject {
    constructor(type, x, y, width, height, color = '#3498db', label = '–û–±—ä–µ–∫—Ç') {
      this.id = Date.now() + Math.random();
      this.type = type;
      this.x = x;
      this.y = y;
      this.width = width;
      this.height = height;
      this.color = color;
      this.label = label;
      this.selected = false;
      this.properties = {};
      this.image = null;
      this.imageLoaded = false;
      this.rotation = 0; // –£–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    loadImage(imageUrl) {
      return new Promise((resolve, reject) => {
        this.image = new Image();
        this.image.onload = () => {
          this.imageLoaded = true;
          resolve();
        };
        this.image.onerror = () => {
          this.imageLoaded = false;
          reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
        };
        this.image.src = imageUrl;
      });
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
    rotate(degrees = 90) {
      this.rotation = (this.rotation + degrees) % 360;
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    draw(ctx) {
      // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ä–∏—Å—É–µ–º –µ–≥–æ —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
      if (this.image && this.imageLoaded) {
        ctx.save();

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Ü–µ–Ω—Ç—Ä –æ–±—ä–µ–∫—Ç–∞
        const centerX = this.x + this.width / 2;
        const centerY = this.y + this.height / 2;
        ctx.translate(centerX, centerY);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ
        ctx.rotate((this.rotation * Math.PI) / 180);

        // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
        ctx.drawImage(this.image, -this.width / 2, -this.height / 2, this.width, this.height);

        ctx.restore();
      } else {
        // –ò–Ω–∞—á–µ —Ä–∏—Å—É–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.width, this.height);

        // –¢–µ–∫—Å—Ç –º–µ—Ç–∫–∏
        ctx.fillStyle = 'white';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.label, this.x + this.width / 2, this.y + this.height / 2);
      }

      // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤—ã–±—Ä–∞–Ω, —Ä–∏—Å—É–µ–º —Ä–∞–º–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è
      if (this.selected) {
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(this.x - 5, this.y - 5, this.width + 10, this.height + 10);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è
        ctx.fillStyle = '#ff0000';
        ctx.font = '10px Arial';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillText(`${this.rotation}¬∞`, this.x - 5, this.y - 15);

        ctx.setLineDash([]);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞
    isPointInside(x, y) {
      return x >= this.x &&
        x <= this.x + this.width &&
        y >= this.y &&
        y <= this.y + this.height;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞
    getProperties() {
      return {
        type: this.type,
        x: this.x,
        y: this.y,
        width: this.width,
        height: this.height,
        color: this.color,
        label: this.label,
        rotation: this.rotation,
        ...this.properties
      };
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    setPosition(x, y) {
      this.x = x;
      this.y = y;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤
    setSize(width, height) {
      this.width = width;
      this.height = height;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏
    setLabel(label) {
      this.label = label;
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–∞—â–µ–Ω–∏—è
    setRotation(rotation) {
      this.rotation = rotation;
    }
  }

  // –ö–ª–∞—Å—Å –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
  class ImageObject extends CanvasObject {
    constructor(type, x, y, width, height, imageUrl, label = '–û–±—ä–µ–∫—Ç') {
      super(type, x, y, width, height, '#3498db', label);
      this.properties = {
        imageUrl: imageUrl
      };

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞
      if (imageUrl) {
        this.loadImage(imageUrl).catch(error => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
        });
      }
    }

    draw(ctx) {
      // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ä–∏—Å—É–µ–º –µ–≥–æ —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
      if (this.image && this.imageLoaded) {
        ctx.save();

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Ü–µ–Ω—Ç—Ä –æ–±—ä–µ–∫—Ç–∞
        const centerX = this.x + this.width / 2;
        const centerY = this.y + this.height / 2;
        ctx.translate(centerX, centerY);

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ
        ctx.rotate((this.rotation * Math.PI) / 180);

        // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –≤—Ä–∞—â–µ–Ω–∏—è
        ctx.drawImage(this.image, -this.width / 2, -this.height / 2, this.width, this.height);

        ctx.restore();
      } else {
        // –ò–Ω–∞—á–µ —Ä–∏—Å—É–µ–º placeholder
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(this.x, this.y, this.width, this.height);

        ctx.strokeStyle = '#999';
        ctx.lineWidth = 1;
        ctx.strokeRect(this.x, this.y, this.width, this.height);

        ctx.fillStyle = '#999';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(this.label, this.x + this.width / 2, this.y + this.height / 2);
      }

      // –¢–µ–∫—Å—Ç –ø–æ–¥ –æ–±—ä–µ–∫—Ç–æ–º
      ctx.fillStyle = 'black';
      ctx.font = '10px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(this.label, this.x + this.width / 2, this.y + this.height + 5);

      // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç –≤—ã–±—Ä–∞–Ω, —Ä–∏—Å—É–µ–º —Ä–∞–º–∫—É –≤—ã–¥–µ–ª–µ–Ω–∏—è
      if (this.selected) {
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(this.x - 5, this.y - 5, this.width + 10, this.height + 10);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è
        ctx.fillStyle = '#ff0000';
        ctx.font = '10px Arial';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillText(`${this.rotation}¬∞`, this.x - 5, this.y - 15);

        ctx.setLineDash([]);
      }
    }
  }

  // –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
  class ObjectFactory {
    static createObject(type, x, y) {
      const objectConfigs = {
        'door': { width: 15, height: 30, image: './img/dvercloses.png', label: '–î–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–≤–∞—è', tth: '' },
        'door2': { width: 15, height: 30, image: './img/dverwentoknowood.png', label: '–î–≤–µ—Ä—å –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Å –≤–µ–Ω—Ç–æ—Ç–∫–Ω–æ–º' },
        'door3': { width: 15, height: 30, image: './img/dverventrech.png', label: '–î–≤–µ—Ä—å —Å –≤–µ–Ω—Ç—Ä–µ—à–µ—Ç–∫–æ–π' },
        'door4': { width: 15, height: 30, image: './img/dveropenmetall.png', label: '–î–≤–µ—Ä—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –æ—Ç–∫—Ä—ã—Ç–∞—è' },

        'fan': { width: 40, height: 30, image: './img/fan.png', label: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π' },
        'fan2': { width: 40, height: 30, image: './img/fan2.png', label: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä' },

        'fire': { width: 40, height: 30, image: './img/fire.png', label: '–û–≥–æ–Ω—å' },
        'fire2': { width: 40, height: 30, image: './img/pozarniigidrant.png', label: '–ü–æ–∂–∞—Ä–Ω—ã–π –≥–∏–¥—Ä–∞–Ω—Ç' },

        'boom': { width: 40, height: 30, image: './img/massovievzivniepaboti.png', label: '–ú–∞—Å—Å–æ–≤—ã–π –≤–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã' },
        'boom2': { width: 40, height: 30, image: './img/vzrivnieraboti.png', label: '–í–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã' },

        'medical': { width: 40, height: 30, image: './img/medpunkt.png', label: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø—É–Ω–∫—Ç' },

        'building': { width: 30, height: 30, image: './img/nadshahtnoe.png', label: '–ù–∞–¥—à–∞—Ö—Ç–Ω–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ' },

        'pumps': { width: 40, height: 30, image: './img/nanospogruznoi.png', label: '–ù–∞—Å–æ—Å –ø–æ–≥—Ä—É–∂–Ω–æ–π' },
        'pumps2': { width: 40, height: 30, image: './img/nasosnayastancia.png', label: '–ù–∞—Å–æ—Å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è' },

        'people': { width: 40, height: 30, image: './img/people.png', label: '–õ—é–¥–∏' },

        'jumper': { width: 10, height: 30, image: './img/petemichkabeton.png', label: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –±–µ—Ç–æ–Ω–Ω–∞—è' },
        'jumper2': { width: 10, height: 30, image: './img/petemichkakirpich.png', label: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –∫–∏—Ä–ø–∏—á–Ω–∞—è' },
        'jumper3': { width: 10, height: 30, image: './img/petemichkametall.png', label: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è' },
        'jumper4': { width: 10, height: 30, image: './img/petemichkawood.png', label: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è' },

        'phone': { width: 40, height: 35, image: './img/phone.png', label: '–¢–µ–ª–µ—Ñ–æ–Ω' },

        'equipment': { width: 40, height: 40, image: './img/samohodnoe.png', label: '–°–∞–º–æ—Ö–æ–¥–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ' },

        'entrance': { width: 40, height: 10, image: './img/zapasvhod.png', label: '–ó–∞–ø–∞—Å–Ω–æ–π –≤—Ö–æ–¥' },
      };

      const config = objectConfigs[type];
      if (config) {
        return new ImageObject(type, x, y, config.width, config.height, config.image, config.label);
      } else {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤
        return new CanvasObject('generic', x, y, 50, 50, '#3498db', '–û–±—ä–µ–∫—Ç');
      }
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∏–ø–∞—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    static getObjectTypes() {
      return [
        { type: 'door', name: '–î–≤–µ—Ä—å –∑–∞–∫—Ä—ã—Ç–≤–∞—è', icon: './img/dvercloses.png', category: 'doors_windows' },
        { type: 'door2', name: '–î–≤–µ—Ä—å –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Å –≤–µ–Ω—Ç–æ—Ç–∫–Ω–æ–º', icon: './img/dverwentoknowood.png', category: 'doors_windows' },
        { type: 'door3', name: '–î–≤–µ—Ä—å —Å –≤–µ–Ω—Ç—Ä–µ—à–µ—Ç–∫–æ–π', icon: './img/dverventrech.png', category: 'doors_windows' },
        { type: 'door4', name: '–î–≤–µ—Ä—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –æ—Ç–∫—Ä—ã—Ç–∞—è', icon: './img/dveropenmetall.png', category: 'doors_windows' },

        { type: 'fan', name: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π', icon: './img/fan.png', category: 'fan' },
        { type: 'fan2', name: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä', icon: './img/fan2.png', category: 'fan' },

        { type: 'fire', name: '–û–≥–æ–Ω—å', icon: './img/fire.png', category: 'fire' },
        { type: 'fire2', name: '–ü–æ–∂–∞—Ä–Ω—ã–π –≥–∏–¥—Ä–∞–Ω—Ç', icon: './img/pozarniigidrant.png', category: 'fire' },

        { type: 'boom', name: '–ú–∞—Å—Å–æ–≤—ã–π –≤–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', icon: './img/massovievzivniepaboti.png', category: 'boom' },
        { type: 'boom2', name: '–í–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', icon: './img/vzrivnieraboti.png', category: 'boom' },

        { type: 'medical', name: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ø—É–Ω–∫—Ç', icon: './img/medpunkt.png', category: 'medical' },

        { type: 'building', name: '–ù–∞–¥—à–∞—Ö—Ç–Ω–æ–µ —Å—Ç—Ä–æ–µ–Ω–∏–µ', icon: './img/nadshahtnoe.png', category: 'building' },

        { type: 'pumps', name: '–ù–∞—Å–æ—Å –ø–æ–≥—Ä—É–∂–Ω–æ–π', icon: './img/nanospogruznoi.png', category: 'pumps' },
        { type: 'pumps2', name: '–ù–∞—Å–æ—Å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è', icon: './img/nasosnayastancia.png', category: 'pumps' },

        { type: 'people', name: '–õ—é–¥–∏', icon: './img/people.png', category: 'people' },

        { type: 'jumper', name: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –±–µ—Ç–æ–Ω–Ω–∞—è', icon: './img/petemichkabeton.png', category: 'jumper' },
        { type: 'jumper2', name: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –∫–∏—Ä–ø–∏—á–Ω–∞—è', icon: './img/petemichkakirpich.png', category: 'jumper' },
        { type: 'jumper3', name: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è', icon: './img/petemichkametall.png', category: 'jumper' },
        { type: 'jumper4', name: '–ü–µ—Ä–µ–º—ã—á–∫–∞ –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è', icon: './img/petemichkawood.png', category: 'jumper' },

        { type: 'phone', name: '–¢–µ–ª–µ—Ñ–æ–Ω', icon: './img/phone.png', category: 'phone' },

        { type: 'equipment', name: '–°–∞–º–æ—Ö–æ–¥–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ', icon: './img/samohodnoe.png', category: 'equipment' },

        { type: 'entrance', name: '–ó–∞–ø–∞—Å–Ω–æ–π –≤—Ö–æ–¥', icon: './img/zapasvhod.png', category: 'entrance' },
      ];
    }
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  class Editor {
    constructor(canvasId) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext('2d');

      // –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
      this.mode = 'draw';
      this.lineColor = 'gray';
      this.lineWidth = 10;
      this.snapToGrid = true;
      this.snapToPoints = true;
      this.gridSize = 20;
      this.cheight = null;
      this.cwidth = null;
      this.cvolume = null;

      // –°–æ—Å—Ç–æ—è–Ω–∏–µ
      this.isDrawing = false;
      this.isMoving = false;
      this.isEditing = false;
      this.selectedElement = null;
      this.dragOffset = { x: 0, y: 0 };
      this.editingPoint = null;

      // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏–Ω—ã
      this.editingLength = false;
      this.lengthEditOverlay = null;

      // –•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö
      this.lines = [];
      this.objects = [];
      this.tempLine = null;

      // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–∞–º–∏
      this.currentObjectType = null;

      // –î–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ª–∏–Ω–∏–π
      this.lineToSplit = null;
      this.splitPoint = null;

      this.init();
    }

    init() {
      this.setupEventListeners();
      this.setupUI();
      this.setupObjectLibrary();
      this.redraw();
    }

    setupEventListeners() {
      // –°–æ–±—ã—Ç–∏—è canvas
      this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
      this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
      this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
      this.canvas.addEventListener('mouseout', this.handleMouseOut.bind(this));
      this.canvas.addEventListener('dblclick', this.handleDoubleClick.bind(this));

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', this.handleResize.bind(this));
      this.handleResize();
    }

    handleResize() {
      const container = this.canvas.parentElement;
      const width = container.clientWidth - 40;
      const height = container.clientHeight - 80;

      if (this.canvas.width !== width || this.canvas.height !== height) {
        this.canvas.width = width;
        this.canvas.height = height;
        this.redraw();
      }
    }

    setupUI() {
      // –ö–Ω–æ–ø–∫–∏ —Ä–µ–∂–∏–º–æ–≤
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          this.setMode(e.target.dataset.mode);
          // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
          this.currentObjectType = null;
          document.querySelectorAll('.object-item').forEach(item => {
            item.classList.remove('selected');
          });

          // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ —Å–≤–æ–π—Å—Ç–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–æ–≤
          this.hidePropertiesPanel();
          this.hideLinePropertiesPanel();
        });
      });

      // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          this.setColor(e.target.dataset.color);
        });
      });

      // –ü—Ä–∏–≤—è–∑–∫–∞
      document.getElementById('snapToGrid').addEventListener('change', (e) => {
        this.snapToGrid = e.target.checked;
        this.redraw();
      });

      document.getElementById('snapToPoints').addEventListener('change', (e) => {
        this.snapToPoints = e.target.checked;
      });

      // –î–µ–π—Å—Ç–≤–∏—è
      document.getElementById('clearAll').addEventListener('click', () => {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')) {
          this.lines = [];
          this.objects = [];
          this.hidePropertiesPanel();
          this.hideLinePropertiesPanel();
          this.redraw();
        }
      });

      document.getElementById('showAllLines').addEventListener('click', () => {
        console.log('–õ–∏–Ω–∏–∏:', this.lines);
        console.log('–û–±—ä–µ–∫—Ç—ã:', this.objects);
        alert(`–õ–∏–Ω–∏–π: ${this.lines.length}, –û–±—ä–µ–∫—Ç–æ–≤: ${this.objects.length}`);
      });

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PDF
      document.getElementById('savePDF').addEventListener('click', () => {
        this.saveAsPDF();
      });

      // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
      document.getElementById('rotateButton').addEventListener('click', () => {
        this.rotateSelectedObject();
      });

      document.getElementById('applyProperties').addEventListener('click', () => {
        this.applyObjectProperties();
      });

      document.getElementById('cancelProperties').addEventListener('click', () => {
        this.hidePropertiesPanel();
      });

      // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏
      document.getElementById('applyLineProperties').addEventListener('click', () => {
        this.applyLineProperties();
      });

      document.getElementById('cancelLineProperties').addEventListener('click', () => {
        this.hideLinePropertiesPanel();
      });

      // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≤–æ–π—Å—Ç–≤ –≤—Å–µ—Ö –ª–∏–Ω–∏–π
      document.getElementById('showLineProperties').addEventListener('click', () => {
        this.showAllLinesProperties();
      });
    }

    setupObjectLibrary() {
      // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤
      const categories = document.querySelectorAll('.category-btn');
      categories.forEach(btn => {
        btn.addEventListener('click', (e) => {
          categories.forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          this.showCategory(e.target.dataset.category);
        });
      });

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ–±—ä–µ–∫—Ç–æ–≤
      this.populateObjectLibrary();
    }

    populateObjectLibrary() {
      const objectsGrid = document.getElementById('objectsGrid');
      objectsGrid.innerHTML = '';

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–∏–ø–∞—Ö –æ–±—ä–µ–∫—Ç–æ–≤
      const objectTypes = ObjectFactory.getObjectTypes();

      objectTypes.forEach(objInfo => {
        const objElement = document.createElement('div');
        objElement.className = 'object-item';
        objElement.innerHTML = `
                        <div class="object-icon">
                            <img src="${objInfo.icon}" alt="..." title="${objInfo.name}"/>
                        </div>
                        <div class="object-name">${objInfo.name}</div>
                    `;
        objElement.dataset.type = objInfo.type;
        objElement.dataset.category = objInfo.category;

        objElement.addEventListener('click', () => {
          document.querySelectorAll('.object-item').forEach(item => {
            item.classList.remove('selected');
          });
          objElement.classList.add('selected');
          this.currentObjectType = objInfo.type;
          this.setMode('draw');
        });

        objectsGrid.appendChild(objElement);
      });
    }

    showCategory(category) {
      const objects = document.querySelectorAll('.object-item');
      objects.forEach(obj => {
        if (category === 'all' || obj.dataset.category === category) {
          obj.style.display = 'flex';
        } else {
          obj.style.display = 'none';
        }
      });
    }

    setMode(mode) {
      this.mode = mode;

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
      switch (mode) {
        case 'draw':
          this.canvas.style.cursor = 'crosshair';
          document.getElementById('currentMode').textContent =
            this.currentObjectType ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤' : '–†–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–π';
          break;
        case 'move':
          this.canvas.style.cursor = 'move';
          document.getElementById('currentMode').textContent = '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ';
          break;
        case 'edit':
          this.canvas.style.cursor = 'pointer';
          document.getElementById('currentMode').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
          break;
        case 'delete':
          this.canvas.style.cursor = 'not-allowed';
          document.getElementById('currentMode').textContent = '–£–¥–∞–ª–µ–Ω–∏–µ';
          break;
      }
    }

    setColor(color) {
      this.lineColor = color;

      document.querySelectorAll('.color-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      const colorBtn = document.querySelector(`[data-color="${color}"]`);
      if (colorBtn) {
        colorBtn.classList.add('active');
      }

      document.getElementById('currentColor').textContent = color;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞
    showPropertiesPanel(obj) {
      const panel = document.getElementById('propertiesPanel');
      const labelInput = document.getElementById('propertyLabel');
      const widthInput = document.getElementById('propertyWidth');
      const heightInput = document.getElementById('propertyHeight');

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –æ–±—ä–µ–∫—Ç–∞
      labelInput.value = obj.label;
      widthInput.value = obj.width;
      heightInput.value = obj.height;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      panel.style.display = 'block';
    }

    // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤
    hidePropertiesPanel() {
      const panel = document.getElementById('propertiesPanel');
      panel.style.display = 'none';
      this.selectedElement = null;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏
    showLinePropertiesPanel(line) {
      const panel = document.getElementById('linePropertiesPanel');
      const cheightInput = document.getElementById('lineCheight');
      const cwidthInput = document.getElementById('lineCwidth');
      const cvolumeInput = document.getElementById('lineCvolume');
      const lengthInput = document.getElementById('lineLength');

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ –ª–∏–Ω–∏–∏
      cheightInput.value = line.cheight || '';
      cwidthInput.value = line.cwidth || '';
      cvolumeInput.value = line.cvolume || '';
      lengthInput.value = `${this.calculateLineLength(line).toFixed(1)}m`;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      panel.style.display = 'block';
    }

    // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏
    hideLinePropertiesPanel() {
      const panel = document.getElementById('linePropertiesPanel');
      panel.style.display = 'none';
      this.selectedElement = null;
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
    applyObjectProperties() {
      if (!this.selectedElement) return;

      const labelInput = document.getElementById('propertyLabel');
      const widthInput = document.getElementById('propertyWidth');
      const heightInput = document.getElementById('propertyHeight');

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
      this.selectedElement.setLabel(labelInput.value);
      this.selectedElement.setSize(parseInt(widthInput.value), parseInt(heightInput.value));

      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º canvas
      this.redraw();
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏
    applyLineProperties() {
      if (!this.selectedElement || !this.selectedElement.start) return;

      const cheightInput = document.getElementById('lineCheight');
      const cwidthInput = document.getElementById('lineCwidth');
      const cvolumeInput = document.getElementById('lineCvolume');

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏
      this.selectedElement.cheight = cheightInput.value ? parseFloat(cheightInput.value) : null;
      this.selectedElement.cwidth = cwidthInput.value ? parseFloat(cwidthInput.value) : null;
      this.selectedElement.cvolume = cvolumeInput.value ? parseFloat(cvolumeInput.value) : null;

      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º canvas
      this.redraw();

      // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
      this.hideLinePropertiesPanel();
    }

    // –í—Ä–∞—â–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    rotateSelectedObject() {
      if (!this.selectedElement) return;

      this.selectedElement.rotate(90); // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ 90 –≥—Ä–∞–¥—É—Å–æ–≤
      this.redraw();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –≤—Å–µ—Ö –ª–∏–Ω–∏–π
    showAllLinesProperties() {
      const linesProperties = this.getAllLinesProperties();
      console.log('–°–≤–æ–π—Å—Ç–≤–∞ –≤—Å–µ—Ö –ª–∏–Ω–∏–π:', linesProperties);

      // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ alert
      let message = `–í—Å–µ–≥–æ –ª–∏–Ω–∏–π: ${linesProperties.length}\n\n`;
      linesProperties.forEach((line, index) => {
        message += `–õ–∏–Ω–∏—è ${index + 1}:\n`;
        message += `  –î–ª–∏–Ω–∞: ${line.realLength.toFixed(1)}m\n`;
        message += `  –í—ã—Å–æ—Ç–∞: ${line.cheight || '–Ω–µ –∑–∞–¥–∞–Ω–∞'}\n`;
        message += `  –®–∏—Ä–∏–Ω–∞: ${line.cwidth || '–Ω–µ –∑–∞–¥–∞–Ω–∞'}\n`;
        message += `  –û–±—ä–µ–º: ${line.cvolume || '–Ω–µ –∑–∞–¥–∞–Ω–∞'}\n\n`;
      });

      alert(message);
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –≤—Å–µ—Ö –ª–∏–Ω–∏–π
    getAllLinesProperties() {
      return this.lines.map(line => this.getLineProperties(line));
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–∏–Ω–∏–∏
    getLineProperties(line) {
      return {
        id: line.id,
        start: { ...line.start },
        end: { ...line.end },
        color: line.color,
        width: line.width,
        cheight: line.cheight,
        cwidth: line.cwidth,
        cvolume: line.cvolume,
        customLength: line.customLength,
        realLength: this.calculateLineLength(line)
      };
    }

    getMousePos(e) {
      const rect = this.canvas.getBoundingClientRect();
      const scaleX = this.canvas.width / rect.width;
      const scaleY = this.canvas.height / rect.height;

      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }

    snapPosition(x, y) {
      let snappedX = x;
      let snappedY = y;

      // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
      if (this.snapToGrid) {
        snappedX = Math.round(x / this.gridSize) * this.gridSize;
        snappedY = Math.round(y / this.gridSize) * this.gridSize;
      }

      // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–æ—á–∫–∞–º –ª–∏–Ω–∏–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤
      if (this.snapToPoints) {
        let closestDistance = 15;
        let closestPoint = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–µ–∫ –ª–∏–Ω–∏–π
        this.lines.forEach(line => {
          [line.start, line.end].forEach(point => {
            const distance = Math.sqrt(
              Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2)
            );
            if (distance < closestDistance) {
              closestDistance = distance;
              closestPoint = point;
            }
          });
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≥–ª–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        this.objects.forEach(obj => {
          const points = [
            { x: obj.x, y: obj.y },
            { x: obj.x + obj.width, y: obj.y },
            { x: obj.x, y: obj.y + obj.height },
            { x: obj.x + obj.width, y: obj.y + obj.height }
          ];

          points.forEach(point => {
            const distance = Math.sqrt(
              Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2)
            );
            if (distance < closestDistance) {
              closestDistance = distance;
              closestPoint = point;
            }
          });
        });

        if (closestPoint) {
          snappedX = closestPoint.x;
          snappedY = closestPoint.y;
        }
      }

      return { x: snappedX, y: snappedY };
    }

    handleMouseDown(e) {
      const mousePos = this.getMousePos(e);
      const snappedPos = this.snapPosition(mousePos.x, mousePos.y);

      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç
      if (this.mode === 'draw' && this.currentObjectType) {
        this.addObject(this.currentObjectType, snappedPos.x, snappedPos.y);
        return;
      }

      switch (this.mode) {
        case 'draw':
          this.startDrawing(snappedPos);
          break;
        case 'move':
          this.startMoving(snappedPos);
          break;
        case 'edit':
          this.startEditing(snappedPos);
          break;
        case 'delete':
          this.deleteAtPosition(snappedPos);
          break;
      }
    }

    handleMouseMove(e) {
      const mousePos = this.getMousePos(e);
      const snappedPos = this.snapPosition(mousePos.x, mousePos.y);

      switch (this.mode) {
        case 'draw':
          this.continueDrawing(snappedPos);
          break;
        case 'move':
          this.continueMoving(snappedPos);
          break;
        case 'edit':
          this.continueEditing(snappedPos);
          break;
      }

      // // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏–≤—è–∑–∫–∏
      // if (this.snapToGrid || this.snapToPoints) {
      //   this.showSnapIndicator(snappedPos.x, snappedPos.y);
      // }
    }

    handleMouseUp() {
      switch (this.mode) {
        case 'draw':
          this.finishDrawing();
          break;
        case 'move':
        case 'edit':
          this.finishInteraction();
          break;
      }
    }

    handleMouseOut() {
      if (this.mode === 'draw') {
        this.finishDrawing();
      }
    }

    handleDoubleClick(e) {
      if (this.mode !== 'edit') return;

      const mousePos = this.getMousePos(e);
      const snappedPos = this.snapPosition(mousePos.x, mousePos.y);
      const line = this.findLineAtPoint(snappedPos);

      if (line) {
        this.startLengthEditing(line, snappedPos);
      }
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–π —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ª–∏–Ω–∏–π
    startDrawing(pos) {
      this.isDrawing = true;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ–º –ª–∏ –º—ã —Ä–∏—Å–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–∏–Ω–∏–∏
      if (!this.currentObjectType) {
        const lineAtPoint = this.findLineAtPoint(pos);
        if (lineAtPoint && this.isPointOnLine(pos, lineAtPoint, 10)) {
          // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ª–∏–Ω–∏—é –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
          this.lineToSplit = lineAtPoint;
          this.splitPoint = { ...pos };
        }
      }

      this.tempLine = {
        start: { ...pos },
        end: { ...pos },
        color: this.lineColor,
        width: this.lineWidth,
        cheight: this.cheight,
        cwidth: this.cwidth,
        cvolume: this.cvolume,
      };
    }

    continueDrawing(pos) {
      if (this.isDrawing && this.tempLine) {
        this.tempLine.end = { ...pos };
        this.redraw();
      }
    }

    finishDrawing() {
      if (this.isDrawing && this.tempLine) {
        const dx = this.tempLine.end.x - this.tempLine.start.x;
        const dy = this.tempLine.end.y - this.tempLine.start.y;
        const length = Math.sqrt(dx * dx + dy * dy);

        if (length > 5) {
          // –ï—Å–ª–∏ –º—ã –Ω–∞—á–∞–ª–∏ —Ä–∏—Å–æ–≤–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–∏–Ω–∏–∏, —Ä–∞–∑–¥–µ–ª—è–µ–º –µ–µ
          if (this.lineToSplit && this.splitPoint) {
            this.splitLine(this.lineToSplit, this.splitPoint);
          }

          this.lines.push({
            ...this.tempLine,
            id: Date.now() + Math.random()
          });
        }

        this.tempLine = null;
        this.isDrawing = false;
        this.lineToSplit = null;
        this.splitPoint = null;
        this.redraw();
      }
    }

    // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏
    splitLine(line, splitPoint) {
      // –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–≤—ã–µ –ª–∏–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ö–æ–¥–Ω–æ–π
      const line1 = {
        ...line,
        id: Date.now() + Math.random(),
        start: { ...line.start },
        end: { ...splitPoint }
      };

      const line2 = {
        ...line,
        id: Date.now() + Math.random() + 1,
        start: { ...splitPoint },
        end: { ...line.end }
      };

      // –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ª–∏–Ω–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–≤–µ –Ω–æ–≤—ã–µ
      this.lines = this.lines.filter(l => l.id !== line.id);
      this.lines.push(line1, line2);
    }

    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
    startMoving(pos) {
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç—ã
      this.selectedElement = this.findObjectAtPoint(pos);
      if (this.selectedElement) {
        this.isMoving = true;
        this.dragOffset = {
          x: pos.x - this.selectedElement.x,
          y: pos.y - this.selectedElement.y
        };
        return;
      }

      // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–∏–∏
      this.selectedElement = this.findLineAtPoint(pos);
      if (this.selectedElement) {
        this.isMoving = true;
        this.dragOffset = {
          x: pos.x - this.selectedElement.start.x,
          y: pos.y - this.selectedElement.start.y
        };
      }
    }

    continueMoving(pos) {
      if (this.isMoving && this.selectedElement) {
        if (this.selectedElement.start && this.selectedElement.end) {
          // –≠—Ç–æ –ª–∏–Ω–∏—è
          const newStartX = pos.x - this.dragOffset.x;
          const newStartY = pos.y - this.dragOffset.y;

          const deltaX = newStartX - this.selectedElement.start.x;
          const deltaY = newStartY - this.selectedElement.start.y;

          this.selectedElement.start.x = newStartX;
          this.selectedElement.start.y = newStartY;
          this.selectedElement.end.x += deltaX;
          this.selectedElement.end.y += deltaY;
        } else {
          // –≠—Ç–æ –æ–±—ä–µ–∫—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ setPosition
          this.selectedElement.setPosition(
            pos.x - this.dragOffset.x,
            pos.y - this.dragOffset.y
          );
        }

        this.redraw();
      }
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –ª–∏–Ω–∏–∏
    startEditing(pos) {
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç—ã
      this.selectedElement = this.findObjectAtPoint(pos);
      if (this.selectedElement) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        this.showPropertiesPanel(this.selectedElement);
        return;
      }

      // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–∏–∏ - –∏—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Ç–æ—á–∫—É –ª–∏–Ω–∏–∏
      this.selectedElement = this.findLineAtPoint(pos);
      if (this.selectedElement) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é —Ç–æ—á–∫—É –ª–∏–Ω–∏–∏ –º—ã —Ö–æ—Ç–∏–º –ø–µ—Ä–µ–º–µ—â–∞—Ç—å
        const distToStart = this.distance(pos, this.selectedElement.start);
        const distToEnd = this.distance(pos, this.selectedElement.end);

        // –ï—Å–ª–∏ –∫–ª–∏–∫ –±–ª–∏–∑–∫–æ –∫ –æ–¥–Ω–æ–π –∏–∑ —Ç–æ—á–µ–∫, –ø–µ—Ä–µ–º–µ—â–∞–µ–º —ç—Ç—É —Ç–æ—á–∫—É
        if (distToStart < 10 || distToEnd < 10) {
          this.isEditing = true;
          this.editingPoint = distToStart < distToEnd ? 'start' : 'end';

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
          const targetPoint = this.selectedElement[this.editingPoint];
          this.dragOffset = {
            x: pos.x - targetPoint.x,
            y: pos.y - targetPoint.y
          };
        } else {
          // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –±–ª–∏–∑–∫–æ –∫ —Ç–æ—á–∫–∞–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤
          this.showLinePropertiesPanel(this.selectedElement);
        }
        return;
      }

      // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ –Ω–∞ –æ–±—ä–µ–∫—Ç –∏ –Ω–µ –Ω–∞ –ª–∏–Ω–∏—é, —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª–∏ —Å–≤–æ–π—Å—Ç–≤
      this.hidePropertiesPanel();
      this.hideLinePropertiesPanel();
    }

    continueEditing(pos) {
      if (this.isEditing && this.selectedElement && this.editingPoint) {
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–æ—á–∫—É –ª–∏–Ω–∏–∏
        const targetPoint = this.selectedElement[this.editingPoint];
        targetPoint.x = pos.x - this.dragOffset.x;
        targetPoint.y = pos.y - this.dragOffset.y;

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏–≤—è–∑–∫—É –∫ —Å–µ—Ç–∫–µ
        if (this.snapToGrid) {
          const snappedPos = this.snapPosition(targetPoint.x, targetPoint.y);
          targetPoint.x = snappedPos.x;
          targetPoint.y = snappedPos.y;
        }

        this.redraw();
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ
    deleteAtPosition(pos) {
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ä–µ–∫—Ç—ã
      const objectToDelete = this.findObjectAtPoint(pos);
      if (objectToDelete) {
        this.objects = this.objects.filter(obj => obj !== objectToDelete);
        this.hidePropertiesPanel();
        this.redraw();
        return;
      }

      // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–∏–∏
      const lineToDelete = this.findLineAtPoint(pos);
      if (lineToDelete) {
        this.lines = this.lines.filter(line => line !== lineToDelete);
        this.hideLinePropertiesPanel();
        this.redraw();
      }
    }

    finishInteraction() {
      this.isMoving = false;
      this.isEditing = false;
      this.editingPoint = null;
      this.dragOffset = { x: 0, y: 0 };
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏–Ω—ã –ª–∏–Ω–∏–∏
    startLengthEditing(line, pos) {
      this.editingLength = true;
      this.selectedElement = line;

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–≤–µ—Ä–ª–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (this.lengthEditOverlay) {
        document.body.removeChild(this.lengthEditOverlay);
      }

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–≤–µ—Ä–ª–µ–π
      this.lengthEditOverlay = document.createElement('div');
      this.lengthEditOverlay.className = 'length-edit-overlay';

      const input = document.createElement('input');
      input.type = 'text';
      input.value = line.customLength || '';
      input.placeholder = '–î–ª–∏–Ω–∞ –≤ m';

      const button = document.createElement('button');
      button.textContent = 'OK';

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ–≤–µ—Ä–ª–µ–π
      const rect = this.canvas.getBoundingClientRect();
      const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
      const scrollY = window.pageXOffset || document.documentElement.scrollTop;

      this.lengthEditOverlay.style.left = (rect.left + pos.x + scrollX) + 'px';
      this.lengthEditOverlay.style.top = (rect.top + pos.y + scrollY) + 'px';

      // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –æ–≤–µ—Ä–ª–µ–π
      this.lengthEditOverlay.appendChild(input);
      this.lengthEditOverlay.appendChild(button);
      document.body.appendChild(this.lengthEditOverlay);

      // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      input.focus();
      input.select();

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      const applyLength = () => {
        const newLength = input.value.trim();
        if (newLength && !isNaN(newLength)) {
          line.customLength = Number(newLength);
        } else {
          delete line.customLength;
        }
        this.redraw();
        this.finishLengthEditing();
      };

      const cancelLength = () => {
        this.finishLengthEditing();
      };

      button.addEventListener('click', applyLength);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          applyLength();
        } else if (e.key === 'Escape') {
          cancelLength();
        }
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–≤–µ—Ä–ª–µ—è
      setTimeout(() => {
        const closeHandler = (e) => {
          if (this.lengthEditOverlay && !this.lengthEditOverlay.contains(e.target)) {
            this.finishLengthEditing();
            document.removeEventListener('mousedown', closeHandler);
          }
        };
        document.addEventListener('mousedown', closeHandler);
      }, 100);
    }

    finishLengthEditing() {
      this.editingLength = false;
      if (this.lengthEditOverlay) {
        document.body.removeChild(this.lengthEditOverlay);
        this.lengthEditOverlay = null;
      }
    }

    // –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    findLineAtPoint(pos, tolerance = 10) {
      for (let line of this.lines) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
        if (this.distance(pos, line.start) < tolerance ||
          this.distance(pos, line.end) < tolerance) {
          return line;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –Ω–∞ —Å–∞–º–æ–π –ª–∏–Ω–∏–∏
        if (this.isPointOnLine(pos, line, tolerance)) {
          return line;
        }
      }
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –Ω–∞ –ª–∏–Ω–∏–∏
    isPointOnLine(point, line, tolerance = 10) {
      const { start, end } = line;

      // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ª–∏–Ω–∏–∏
      const A = point.x - start.x;
      const B = point.y - start.y;
      const C = end.x - start.x;
      const D = end.y - start.y;

      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      let param = -1;

      if (lenSq !== 0) {
        param = dot / lenSq;
      }

      let xx, yy;

      if (param < 0) {
        xx = start.x;
        yy = start.y;
      } else if (param > 1) {
        xx = end.x;
        yy = end.y;
      } else {
        xx = start.x + param * C;
        yy = start.y + param * D;
      }

      const dx = point.x - xx;
      const dy = point.y - yy;
      const distance = Math.sqrt(dx * dx + dy * dy);

      return distance < tolerance;
    }

    findObjectAtPoint(pos, tolerance = 5) {
      for (let i = this.objects.length - 1; i >= 0; i--) {
        const obj = this.objects[i];
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ isPointInside –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞
        if (obj.isPointInside(pos.x, pos.y)) {
          return obj;
        }
      }
      return null;
    }

    isPointInObject(point, obj) {
      return point.x >= obj.x && point.x <= obj.x + obj.width &&
        point.y >= obj.y && point.y <= obj.y + obj.height;
    }

    distance(p1, p2) {
      return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }

    calculateLineLength(line) {
      const dx = line.end.x - line.start.x;
      const dy = line.end.y - line.start.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    redraw() {
      // –û—á–∏—Å—Ç–∫–∞ canvas
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

      // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏
      if (this.snapToGrid) {
        this.drawGrid();
      }

      // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ª–∏–Ω–∏–π
      this.lines.forEach(line => {
        this.drawLine(line);
        this.drawLengthInfo(line);
        this.drawLineProperties(line);
      });

      // –†–∏—Å–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
      this.objects.forEach(obj => {
        this.drawObject(obj);
      });

      // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∏–Ω–∏–∏
      if (this.tempLine) {
        this.drawLine(this.tempLine);
      }

      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
      if (this.selectedElement) {
        this.highlightElement(this.selectedElement);
      }
    }

    drawGrid() {
      this.ctx.save();
      this.ctx.strokeStyle = '#e0e0e0';
      this.ctx.lineWidth = 0.5;

      for (let x = 0; x <= this.canvas.width; x += this.gridSize) {
        this.ctx.beginPath();
        this.ctx.moveTo(x, 0);
        this.ctx.lineTo(x, this.canvas.height);
        this.ctx.stroke();
      }

      for (let y = 0; y <= this.canvas.height; y += this.gridSize) {
        this.ctx.beginPath();
        this.ctx.moveTo(0, y);
        this.ctx.lineTo(this.canvas.width, y);
        this.ctx.stroke();
      }

      this.ctx.restore();
    }

    drawLine(line) {
      this.ctx.save();
      this.ctx.beginPath();
      this.ctx.moveTo(line.start.x, line.start.y);
      this.ctx.lineTo(line.end.x, line.end.y);
      this.ctx.strokeStyle = line.color;
      this.ctx.lineWidth = line.width;
      this.ctx.lineCap = 'round';
      this.ctx.stroke();
      this.ctx.restore();
    }

    drawLengthInfo(line) {
      const midPoint = {
        x: (line.start.x + line.end.x) / 2,
        y: (line.start.y + line.end.y) / 2
      };

      this.ctx.save();
      this.ctx.textAlign = 'center';
      this.ctx.textBaseline = 'middle';

      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –¥–ª–∏–Ω—É, –µ—Å–ª–∏ –æ–Ω–∞ –∑–∞–¥–∞–Ω–∞
      if (line.customLength !== undefined) {
        this.ctx.fillStyle = 'red';
        this.ctx.font = 'bold 12px Arial';
        this.ctx.fillText(`${line.customLength}m`, midPoint.x, midPoint.y - 15);
      } else {
        // –ò–Ω–∞—á–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –≤ –º–µ—Ç—Ä–∞—Ö
        const realLength = this.calculateLineLength(line);
        this.ctx.fillStyle = 'black';
        this.ctx.font = '12px Arial';
        this.ctx.fillText(`${realLength.toFixed(1)}m`, midPoint.x, midPoint.y - 15);
      }

      this.ctx.restore();
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏
    drawLineProperties(line) {
      const midPoint = {
        x: (line.start.x + line.end.x) / 2,
        y: (line.start.y + line.end.y) / 2
      };

      this.ctx.save();
      this.ctx.textAlign = 'center';
      this.ctx.textBaseline = 'middle';
      this.ctx.fillStyle = 'blue';
      this.ctx.font = '10px Arial';

      let propertiesText = '';
      if (line.cheight) propertiesText += `H:${line.cheight} `;
      if (line.cwidth) propertiesText += `W:${line.cwidth} `;
      if (line.cvolume) propertiesText += `V:${line.cvolume}`;

      if (propertiesText) {
        this.ctx.fillText(propertiesText, midPoint.x, midPoint.y + 15);
      }

      this.ctx.restore();
    }

    drawObject(obj) {
      // –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ draw –æ–±—ä–µ–∫—Ç–∞
      obj.draw(this.ctx);
    }

    highlightElement(element) {
      this.ctx.save();
      this.ctx.strokeStyle = '#ff0000';
      this.ctx.lineWidth = 2;
      this.ctx.setLineDash([5, 5]);

      if (element.start && element.end) {
        // –≠—Ç–æ –ª–∏–Ω–∏—è
        const bounds = this.getLineBounds(element);
        this.ctx.strokeRect(bounds.x, bounds.y, bounds.width, bounds.height);

        // –¢–æ—á–∫–∏ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
        this.ctx.fillStyle = '#ff0000';
        this.ctx.beginPath();
        this.ctx.arc(element.start.x, element.start.y, 5, 0, 2 * Math.PI);
        this.ctx.fill();

        this.ctx.beginPath();
        this.ctx.arc(element.end.x, element.end.y, 5, 0, 2 * Math.PI);
        this.ctx.fill();
      } else {
        // –≠—Ç–æ –æ–±—ä–µ–∫—Ç
        this.ctx.strokeRect(element.x - 5, element.y - 5, element.width + 10, element.height + 10);
      }

      this.ctx.restore();
    }

    showSnapIndicator(x, y) {
      this.ctx.save();
      this.ctx.strokeStyle = '#ff0000';
      this.ctx.lineWidth = 1;
      this.ctx.setLineDash([2, 2]);
      this.ctx.beginPath();
      this.ctx.arc(x, y, 3, 0, 2 * Math.PI);
      this.ctx.stroke();
      this.ctx.restore();
    }

    getLineBounds(line) {
      const minX = Math.min(line.start.x, line.end.x);
      const minY = Math.min(line.start.y, line.end.y);
      const maxX = Math.max(line.start.x, line.end.x);
      const maxY = Math.max(line.start.y, line.end.y);

      return {
        x: minX - 10,
        y: minY - 10,
        width: maxX - minX + 20,
        height: maxY - minY + 20
      };
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤
    addObject(type, x, y) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–±—Ä–∏–∫—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
      const obj = ObjectFactory.createObject(type, x, y);
      this.objects.push(obj);
      this.redraw();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ PDF
    saveAsPDF() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ jsPDF
      if (typeof window.jspdf === 'undefined') {
        alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ jsPDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        return;
      }

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π PDF –¥–æ–∫—É–º–µ–Ω—Ç
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ canvas –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const canvas = this.canvas;
      const imgData = canvas.toDataURL('image/png');

      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;

      // –†–∞–∑–º–µ—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã PDF (A4)
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      // –í—ã—á–∏—Å–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      const ratio = Math.min(pdfWidth / canvasWidth, pdfHeight / canvasHeight);
      const scaledWidth = canvasWidth * ratio;
      const scaledHeight = canvasHeight * ratio;

      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      const x = (pdfWidth - scaledWidth) / 2;
      const y = (pdfHeight - scaledHeight) / 2;

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ PDF
      pdf.addImage(imgData, 'PNG', x, y, scaledWidth, scaledHeight);

      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
      const currentDate = new Date().toLocaleDateString('ru-RU');
      pdf.setFontSize(10);
      pdf.text(`–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${currentDate}`, 10, 10);
      pdf.text(`–í—Å–µ–≥–æ –ª–∏–Ω–∏–π: ${this.lines.length}`, 10, 20);
      pdf.text(`–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${this.objects.length}`, 10, 30);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF
      pdf.save('—á–µ—Ä—Ç–µ–∂.pdf');
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ
    getSelectedObjectInfo() {
      if (this.selectedElement && this.selectedElement instanceof CanvasObject) {
        return this.selectedElement.getProperties();
      }
      return null;
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞
    resizeSelectedObject(newWidth, newHeight) {
      if (this.selectedElement && this.selectedElement instanceof CanvasObject) {
        this.selectedElement.setSize(newWidth, newHeight);
        this.redraw();
      }
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  document.addEventListener('DOMContentLoaded', () => {
    const editor = new Editor('drawingCanvas');
    window.editor = editor; // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
  });
</script>
</body>

</html>